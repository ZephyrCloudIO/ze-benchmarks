id: nx-pnpm-monorepo
suite: update-deps
title: "Monorepo with PNPM + Nx; mixed minor & major bumps"
description: |
  Update workspace dependencies; keep @types/node aligned with node engine,
  migrate xterm → @xterm/xterm, avoid bumping tooling pinned by Nx.
timeout_minutes: 40
workspace:
  node: "18.20.x"
  manager: auto
  managers_allowed: [pnpm]
  workspaces: pnpm
baseline:
  run:
    - cmd: "pnpm install"
    - cmd: "pnpm -w -r test --if-present"
    - cmd: "pnpm -w -r lint --if-present"
constraints:
  blocklist:
    - name: "webpack"
      reason: "Pinned by Nx preset; major upgrade breaks builder"
  namespace_migrations:
    - from: "xterm"
      to: "@xterm/xterm"
  companion_versions:
    - main: "node"
      companions:
        - name: "@types/node"
          rule: "major must match"
    - main: "react"
      companions:
        - name: "@types/react"
          rule: "major must match"
targets:
  required:
    - name: "typescript"
      to: ">=5.5 <6"
    - name: "nx"
      to: "~20.0"
  optional:
    - name: "eslint"
      to: "^9"
validation:
  commands:
    install: "pnpm install"
    test: "pnpm -w -r test --if-present"
    lint: "pnpm -w -r lint --if-present"
    typecheck: "pnpm -w -r -F @acme/app tsc --noEmit --project tsconfig.json"
oracle:
  answers_file: "./oracle-answers.json"
llm_judge:
  enabled: true
  model: "meta-llama/llama-3.1-8b-instruct"
  temperature: 0.1
  max_tokens: 2000
  categories:
    - "Dependency Update Correctness (30%): Accurately updates required dependencies (typescript >=5.5 <6, nx ~20.0) and optional targets (eslint ^9) to specified versions. Score 1-5: 1=incorrect versions, 5=all targets met"
    - "Constraint Compliance (25%): Respects blocklist (webpack pinned by Nx), performs namespace migrations (xterm → @xterm/xterm), and maintains companion version alignment (@types/node with node, @types/react with react). Score 1-5: 1=violates constraints, 5=perfect compliance"
    - "Monorepo Handling (20%): Properly handles pnpm workspace structure and Nx monorepo conventions, uses correct workspace commands (pnpm -w -r). Score 1-5: 1=breaks monorepo structure, 5=exemplary monorepo practices"
    - "Breaking Changes Strategy (15%): Handles major version bumps safely, tests for regressions, and maintains compatibility with Nx tooling. Score 1-5: 1=breaks build/tests, 5=seamless upgrades"
    - "Package Manager Correctness (10%): Uses pnpm correctly for workspace operations, maintains lockfile integrity, and follows pnpm best practices. Score 1-5: 1=incorrect commands, 5=optimal pnpm usage"
  
rubric_overrides:
  weights:
    install_success: 1.0
    tests_nonregression: 1.5
    manager_correctness: 1.0
    used_manager_commands: 0.6
    semantic_upgrade_quality: 0.8
    companion_alignment: 0.7
    deprecated_handling: 0.5
    namespace_migrations: 0.7
    breaking_changes_strategy: 0.7
    monorepo_handling: 0.8
    user_questions_quality: 0.4
    efficiency: 0.5
    llm_judge: 1.0
